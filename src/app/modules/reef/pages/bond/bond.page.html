<ng-container *ngIf="bond$ | async as bond; else errorTemplate;">
  <ng-container *ngIf="connectorService.providerUserInfo$ | async as userInfo">
    <div class="row">
      <div class="col">
        <app-page-title
          title="Bond"
          subtitle="Lock tokens long-term and get returns"
        ></app-page-title>
      </div>
    </div>
    <div class="page__wrapper row">
      <div class="col-12 col-sm-8 offset-sm-2 offset-xl-4 col-xl-4">
        <div class="card max-w-350 margin-auto">
          <div class="card-body">
            <div class="text-center">
              <img
                *ngIf="bond.farm!==bond.stake"
                class="img-size-top-65"
                src="{{bond.stakeTokenLogo}}"
                alt="reef-bond"
              />
              <img
                class="img-size-top-65"
                src="{{bond.farmTokenLogo}}"
                alt="reef-bond"
              />
            </div>
            <div class="h6 m-4 text-center">
              Lock token: {{bond.stake}} <br/>
              <span *ngIf="bond.stake!==bond.farm"
              >Rewards token: {{bond.stake}} <br
              /></span>
              Lock duration:
              <ng-container
                *ngIf="UiUtils.toMinTimespanText(bond.farmStartTime,
              bond.farmEndTime) as timespanText"
              >
                {{timespanText}}</ng-container
              >
              <br/>
              APY: {{bond.apy}}%
            </div>
            <ng-container
              *ngIf="(timeLeftToExpired$|async)!=null && toBondSaleStatus(bond)===BondSaleStatus.OPEN else closed"
            >
              <div class="text-center text-muted text-monospace">
                <app-countdown-timer [expiresDate]="bond.entryEndTime"
                >This bond sale ends in
                </app-countdown-timer>
              </div>

              <div class="d-flex flex-column mb-4 text-muted">
                <div>
                  <div class="small mb-1">Deposit {{bond.stake}} amount:</div>
                  <div class="d-flex">
                    <input
                      appNumbersOnlyInput
                      [(ngModel)]="stakeAmount"
                      step="1"
                      class="form-control text-monospace small accent-text"
                      id="stakeAmount"
                      (keydown)="bond.stakeDecimals ? null : UiUtils.keydownPreventDecimal($event)"
                      placeholder="0"
                      type="number"
                    />
                    <div class="w-5-pc">
                      <img
                        style="height: 25px"
                        class="img-size-top-20 margin-em-05"
                        src="{{bond.stakeTokenLogo}}"
                        alt=""
                      />
                    </div>
                  </div>
                  <ng-container
                    *ngIf="(stakeTokenBalance$|async) as stakeTokenBalance"
                  >
                    <app-exceeded-balance-msg
                      *ngIf="stakeAmount!=null && stakeTokenBalance.balance>0"
                      [tokenBalance]="stakeTokenBalance"
                      [tokenAmount]="stakeAmount"
                    ></app-exceeded-balance-msg>
                    <app-set-input-relative-amount
                      [value]="stakeTokenBalance.balance"
                      (valueChange)="stakeAmount=$event.toString()"
                      [tokenSymbol]="bond.stake"
                      (refreshBalance)="apiService.refreshBalancesForAddress.next(stakeTokenBalance.address)"
                    ></app-set-input-relative-amount>
                  </ng-container>
                </div>
              </div>
              <div class="text-center">
                <ng-container
                  *ngIf="TokenUtil.toMaxDisplayDecimalPlaces(BondUtil.getBondReturn(bond, stakeAmount).totalInterestReturn, null, bond.farmDecimals) as stakeAmountInterest; else enterValue "
                >
                  <h5>
                    You will earn <br/>{{stakeAmountInterest}} {{bond.farm}}
                    extra.
                  </h5>
                </ng-container>
                <ng-template #enterValue>
                  <h5>Enter value to <br/>see calculated profits.</h5>
                </ng-template>
                <ng-container
                  *ngIf="(stakeTokenBalance$|async) as stakeTokenBalance"
                >
                  <button
                    [disabled]="!stakeAmount
                      || stakeAmount <= 0
                      || stakeAmount > stakeTokenBalance.balance"
                    (click)="stake(bond, stakeAmount);"
                    class="btn btn-primary m-2"
                  >
                    Get the bond
                  </button>
                </ng-container>
              </div>
              <ng-container *ngIf="stakedBalanceReturn$|async as stakedReturn">
                <p class="text-muted text-center">
                  So far {{stakedReturn.staked}} {{stakedReturn.bond.stake}}
                  locked <br/>for profit of
                  {{TokenUtil.toMaxDisplayDecimalPlaces(stakedReturn.totalInterestReturn,
                  null, bond.farmDecimals)}} {{stakedReturn.bond.farm}} .
                </p>
              </ng-container>
            </ng-container>

            <ng-template #closed>
              <ng-container
                *ngIf="toBondSaleStatus(bond)===BondSaleStatus.LATE; else notStarted"
              >
                <p class="text-center">
                  This bond sale
                  <span class="accent-text"
                  >ended {{bond.entryEndTime|date:'short'}}</span
                  >.<br/>
                  <ng-container
                    *ngIf="stakedBalanceReturn$|async as stakedReturn"
                  >
                    You have
                    <span class="accent-text"
                    >locked {{stakedReturn.staked}}
                      {{stakedReturn.bond.farm}}</span
                    >.<br/>

                    To this moment your interest return amounts to
                    <span class="accent-text"
                    >{{stakedReturn.currentInterestReturn}}
                      {{stakedReturn.bond.farm}}</span
                    >.<br/>
                    Funds will be
                    <span class="accent-text"
                    >unlocked on {{stakedReturn.bond.farmEndTime|date}}</span
                    >
                    in amount of
                    <span class="accent-text"
                    >{{stakedReturn.staked}} {{stakedReturn.bond.stake}}</span
                    >
                    locked and<br/>
                    <span class="accent-text"
                    >{{TokenUtil.toMaxDisplayDecimalPlaces(stakedReturn.totalInterestReturn,
                      null, bond.farmDecimals)}}
                      {{stakedReturn.bond.farm}}</span
                    >
                    interest profit.
                  </ng-container>
                </p>
              </ng-container>
              <ng-template #notStarted>
                <p class="text-center">
                  This bond sale is starting<br/>
                  <span class="accent-text"
                  >at {{bond.entryStartTime|date:'short'}}</span
                  ><br/>
                  <span class="accent-text"
                  ><app-countdown-timer [expiresDate]="bond.entryStartTime"
                  >Get ready for the opening!</app-countdown-timer
                  >
                  </span>
                </p>
              </ng-template>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</ng-container>

<ng-template #errorTemplate>
  <app-empty-state title="Bond not found" subtitle="Bond is not supported yet.">
  </app-empty-state>
</ng-template>
